<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .notification-item {
            background-color: #e9ecef;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .notification-item.chat {
            border-left-color: #28a745;
        }
        .notification-item.system {
            border-left-color: #ffc107;
        }
        .notification-item.ping {
            border-left-color: #6c757d;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>

    <!-- SSE ì—°ê²° ì„¹ì…˜ -->
    <div class="section">
        <h2>ğŸ“¡ SSE ì—°ê²°</h2>
        <div class="form-group">
            <label for="memberName">í˜„ì¬ ì‚¬ìš©ì:</label>
            <input type="text" id="memberName" readonly style="background-color: #f8f9fa; cursor: not-allowed;" placeholder="ë¡œê·¸ì¸ í›„ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤">
        </div>
        <button onclick="connectSSE()" id="connectBtn">ì—°ê²°</button>
        <button onclick="disconnectSSE()" id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
        <div id="connectionStatus" class="status info" style="display: none;">
            ì—°ê²° ëŒ€ê¸° ì¤‘...
        </div>
    </div>

    <!-- ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
    <div class="section">
        <h2>ğŸ“¤ ì•Œë¦¼ ë°œì†¡ í…ŒìŠ¤íŠ¸</h2>
        <div class="form-group">
            <label for="receiverName">ìˆ˜ì‹ ì:</label>
            <input type="text" id="receiverName" placeholder="ì˜ˆ: testuser1" value="testuser1">
        </div>
        <div class="form-group">
            <label for="roomId">ì±„íŒ…ë°© ID:</label>
            <input type="number" id="roomId" placeholder="ì˜ˆ: 1" value="1">
        </div>
        <div class="form-group">
            <label for="senderId">ë°œì‹ ì ID:</label>
            <input type="number" id="senderId" placeholder="ì˜ˆ: 2" value="2">
        </div>
        <!-- ì¶”ê°€: ë©”ì‹œì§€ ID -->
        <div class="form-group">
            <label for="messageId">ë©”ì‹œì§€ ID</label>
            <input type="text" id="messageId" placeholder="ì˜ˆ: 4d2f2b90-... ë˜ëŠ” ULID">
        </div>
        <!-- ê¸°ì¡´ previewëŠ” UI ê·¸ëŒ€ë¡œ ìœ ì§€, ì „ì†¡ ì‹œ messageë¡œ ë§¤í•‘ -->
        <div class="form-group">
            <label for="preview">ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°:</label>
            <textarea id="preview" placeholder="ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤." rows="3">ì•ˆë…•í•˜ì„¸ìš”! ìƒˆë¡œìš´ ë©”ì‹œì§€ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.</textarea>
        </div>
        <button onclick="sendChatNotification()">ì±„íŒ… ì•Œë¦¼ ë°œì†¡</button>
        <button onclick="sendSystemNotification()">ì‹œìŠ¤í…œ ì•Œë¦¼ ë°œì†¡</button>
    </div>

    <!-- ìˆ˜ì‹ ëœ ì•Œë¦¼ ì„¹ì…˜ -->
    <div class="section">
        <h2>ğŸ“¨ ìˆ˜ì‹ ëœ ì•Œë¦¼</h2>
        <button onclick="clearNotifications()">ì•Œë¦¼ ëª©ë¡ ì§€ìš°ê¸°</button>
        <div id="notifications"></div>
    </div>

    <!-- ë¡œê·¸ ì„¹ì…˜ -->
    <div class="section">
        <h2>ğŸ“‹ ë¡œê·¸</h2>
        <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        <div id="log" class="log"></div>
    </div>
</div>

<script>
    let eventSource = null;
    let isConnected = false;

    // ë¡œê·¸ ì¶œë ¥ í•¨ìˆ˜
    function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `[${timestamp}] ${message}`;
        logDiv.appendChild(logEntry);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // ìƒíƒœ ë©”ì‹œì§€ ì¶œë ¥ í•¨ìˆ˜
    function showStatus(message, type = 'info') {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = message;
        statusDiv.className = `status ${type}`;
        statusDiv.style.display = 'block';
    }

    // SSE ì—°ê²°
    function connectSSE() {
        if (eventSource) {
            eventSource.close();
        }

        // ì¸ì¦ í† í°ì´ ìˆëŠ”ì§€ í™•ì¸
        if (!window.authManager || !window.authManager.isLoggedIn()) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ë¡œ SSE ì—°ê²°
        const token = window.authManager.getToken();
        const url = `/api/notify/sse?token=${encodeURIComponent(token)}`;

        // EventSourceëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì¿ í‚¤ë¥¼ í¬í•¨í•˜ì§€ë§Œ, ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •
        eventSource = new EventSource(url, {
            withCredentials: true
        });

        eventSource.onopen = function(event) {
            isConnected = true;
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;

            // ì¸ì¦ëœ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            const user = window.authManager.getCurrentUser();
            const userName = user ? user.membername : 'ì¸ì¦ëœ ì‚¬ìš©ì';
            showStatus(`SSE ì—°ê²°ë¨: ${userName}`, 'success');
            log(`SSE ì—°ê²° ì„±ê³µ: ${userName}`, 'success');
        };

        eventSource.onmessage = function(event) {
            log(`ë©”ì‹œì§€ ìˆ˜ì‹ : ${event.data}`, 'info');
        };

        eventSource.addEventListener('chat', function(event) {
            const data = JSON.parse(event.data);
            addNotification('chat', data, event.id);
            log(`ì±„íŒ… ì•Œë¦¼ ìˆ˜ì‹ : ${JSON.stringify(data)}`, 'success');
        });

        eventSource.addEventListener('system', function(event) {
            const data = JSON.parse(event.data);
            addNotification('system', data, event.id);
            log(`ì‹œìŠ¤í…œ ì•Œë¦¼ ìˆ˜ì‹ : ${JSON.stringify(data)}`, 'success');
        });

        eventSource.addEventListener('ping', async function(event) {
            addNotification('ping', { message: 'Ping received' }, event.id);
            log('Ping ìˆ˜ì‹ ', 'info');

            // í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ ì „ì†¡ (ì¸ì¦ëœ ìš”ì²­ ì‚¬ìš©)
            try {
                const response = await window.authManager.authenticatedFetch(`/api/notify/heartbeat`, {
                    method: 'POST'
                });

                if (response.ok) {
                    log('í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ ì „ì†¡ ì„±ê³µ', 'success');
                } else {
                    log('í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ ì „ì†¡ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                log(`í•˜íŠ¸ë¹„íŠ¸ ì‘ë‹µ ì „ì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        });

        eventSource.onerror = function(event) {
            isConnected = false;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            showStatus('SSE ì—°ê²° ì˜¤ë¥˜', 'error');
            log('SSE ì—°ê²° ì˜¤ë¥˜', 'error');
        };
    }

    // SSE ì—°ê²° í•´ì œ
    function disconnectSSE() {
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
        isConnected = false;
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        showStatus('SSE ì—°ê²° í•´ì œë¨', 'info');
        log('SSE ì—°ê²° í•´ì œ', 'info');
    }

    // ì•Œë¦¼ ì¶”ê°€
    function addNotification(type, data, id) {
        const notificationsDiv = document.getElementById('notifications');
        const notificationDiv = document.createElement('div');
        notificationDiv.className = `notification-item ${type}`;

        const timestamp = new Date().toLocaleTimeString();
        let content = '';

        switch(type) {
            case 'chat': {
                const chatRoomId = data.chatRoomId || data.roomId;
                const senderId = data.senderId;
                const messageId = data.messageId;
                const message = data.message || data.preview || '';
                content = `ğŸ’¬ ì±„íŒ… ì•Œë¦¼ (${timestamp})<br>
                              ${chatRoomId !== undefined ? `ì±„íŒ…ë°©: ${chatRoomId}<br>` : ''}
                              ${senderId !== undefined ? `ë°œì‹ ì: ${senderId}<br>` : ''}
                              ${messageId ? `ë©”ì‹œì§€ID: ${messageId}<br>` : ''}
                              ë‚´ìš©: ${message}`;
                break;
            }
            case 'system':
                content = `ğŸ”” ì‹œìŠ¤í…œ ì•Œë¦¼ (${timestamp})<br>
                              ë‚´ìš©: ${typeof data === 'string' ? data : JSON.stringify(data)}`;
                break;
            case 'ping':
                content = `ğŸ“¡ Ping (${timestamp})`;
                break;
        }

        notificationDiv.innerHTML = content;
        notificationsDiv.appendChild(notificationDiv);
    }

    // ì•Œë¦¼ ëª©ë¡ ì§€ìš°ê¸°
    function clearNotifications() {
        document.getElementById('notifications').innerHTML = '';
        log('ì•Œë¦¼ ëª©ë¡ ì§€ì›€', 'info');
    }

    // ë¡œê·¸ ì§€ìš°ê¸°
    function clearLog() {
        document.getElementById('log').innerHTML = '';
    }

    // ì±„íŒ… ì•Œë¦¼ ë°œì†¡ (ì»¨íŠ¸ë¡¤ëŸ¬ ê·œê²©ì— ë§ì¶° ìˆ˜ì •)
    async function sendChatNotification() {
        const receiverName = document.getElementById('receiverName').value.trim();
        const roomId = document.getElementById('roomId').value;
        const senderId = document.getElementById('senderId').value;
        const messageId = document.getElementById('messageId').value.trim(); // ì¶”ê°€ í•„ìˆ˜ê°’
        const preview = document.getElementById('preview').value.trim();     // UI ìœ ì§€, ì„œë²„ ì „ì†¡ì€ messageë¡œ

        if (!receiverName || !roomId || !senderId || !messageId || !preview) {
            alert('receiverName, roomId, senderId, messageId, message(=preview) ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            // ì¸ì¦ëœ ìš”ì²­ ì‚¬ìš©
            const response = await window.authManager.authenticatedFetch('/api/test/notifications/send-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    receiverName: receiverName,
                    roomId: parseInt(roomId, 10),
                    senderId: parseInt(senderId, 10),
                    messageId: messageId,
                    message: preview
                })
            });

            const result = await response.json();

            if (result.success) {
                log(`ì±„íŒ… ì•Œë¦¼ ë°œì†¡ ì„±ê³µ: ${result.message}`, 'success');
            } else {
                log(`ì±„íŒ… ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ${result.message}`, 'error');
            }
        } catch (error) {
            log(`ì±„íŒ… ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
        }
    }

    // ì‹œìŠ¤í…œ ì•Œë¦¼ ë°œì†¡ (ê·¸ëŒ€ë¡œ ìœ ì§€)
    async function sendSystemNotification() {
        const receiverName = document.getElementById('receiverName').value.trim();
        const message = document.getElementById('preview').value.trim();

        if (!receiverName || !message) {
            alert('ìˆ˜ì‹ ìì™€ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        try {
            // ì¸ì¦ëœ ìš”ì²­ ì‚¬ìš©
            const response = await window.authManager.authenticatedFetch('/api/test/notifications/send-system', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    receiverName: receiverName,
                    message: message
                })
            });

            const result = await response.json();

            if (result.success) {
                log(`ì‹œìŠ¤í…œ ì•Œë¦¼ ë°œì†¡ ì„±ê³µ: ${result.message}`, 'success');
            } else {
                log(`ì‹œìŠ¤í…œ ì•Œë¦¼ ë°œì†¡ ì‹¤íŒ¨: ${result.message}`, 'error');
            }
        } catch (error) {
            log(`ì‹œìŠ¤í…œ ì•Œë¦¼ ë°œì†¡ ì˜¤ë¥˜: ${error.message}`, 'error');
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async function() {
        log('ì•Œë¦¼ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨', 'info');

        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ í™•ì¸ ë° ì„¤ì •
        if (window.authManager && window.authManager.isLoggedIn()) {
            try {
                // í† í° ìœ íš¨ì„± ê²€ì‚¬ ë° ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
                const isValid = await window.authManager.validateToken();
                if (isValid) {
                    const user = window.authManager.getCurrentUser();
                    if (user && user.membername) {
                        document.getElementById('memberName').value = user.membername;
                        document.getElementById('receiverName').value = user.membername;
                        log(`ë¡œê·¸ì¸ëœ ì‚¬ìš©ì: ${user.membername}`, 'success');

                        // ìë™ìœ¼ë¡œ SSE ì—°ê²° ì‹œë„
                        setTimeout(() => {
                            if (confirm('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë¡œ ìë™ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                connectSSE();
                            }
                        }, 1000);
                    } else {
                        log('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    }
                } else {
                    log('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                    alert('ë¡œê·¸ì¸ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    window.location.href = '/test-login.html';
                }
            } catch (error) {
                log(`ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        } else {
            log('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'warning');
        }
    });
</script>

<!-- ê³µí†µ ìŠ¤í¬ë¦½íŠ¸ í¬í•¨ -->
<script src="/js/auth-common.js"></script>
<script src="/js/common-header.js"></script>
</body>
</html>